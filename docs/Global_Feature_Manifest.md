# Undercut: The Global Feature Manifest & User Journey

## 1. Introduction
This document serves as the **Grand Map** of the Undercut ecosystem. It transcends individual roles (Controller, Hunter, Architect) and lists every single feature, logic flow, and user interaction planned for the application.

**Core Mission:** To empower Toronto/GTA car buyers with unfair market intelligence, enabling them to find, analyze, and negotiate deals that are mathematically proven to be underpriced.

---

## 2. The User Journey (Flow)

### 2.1 The "Hook" (Guest Experience)
*   **Entrance:** User lands on `undercut.com`.
*   **Visual:** High-energy dashboard showing "Top 10 Undercut Deals in Toronto Right Now".
    *   *Logic:* Pre-calculated S-Tier deals (10%+ below market).
*   **Interaction:**
    *   User types "Honda Civic" into the search bar.
    *   Results load instantly (sub-100ms) from our Supabase Index.
    *   **Limitation:** Guests see Price, Mileage, and Deal Score. They CANNOT see:
        *   Dealer Name/Phone Number.
        *   Deep AI Analysis (The Mechanic).
        *   Negotiation Scripts.
*   **Persistence:** Guest preferences (e.g., "Sort by Price") are saved in Browser `localStorage`.

### 2.2 The "Conversion" (Sign-Up)
*   **Trigger Points:**
    *   Guest clicks "Analyze Deal".
    *   Guest clicks "Save Search" (Sniper Mode).
    *   Guest clicks "View Seller".
*   **Modal:** "Unlock the Full Market. Sign in with Google."
*   **Authentication:** Google OAuth via Supabase Auth.
*   **The First-Time Setup (Mandatory):**
    *   User is intercepted before returning to content.
    *   **Form:**
        *   First Name (Required).
        *   Commute Distance (km/day).
        *   Postal Code (for proximity).
    *   **Completion:** User clicks "Done" -> Redirected back to the *exact* car they were looking at.

### 2.3 The "Power User" Experience
*   **Dashboard:** specialized "For You" feed based on profile data.
*   **The Analysis:**
    *   User views a 2018 BMW M3.
    *   **The Quant Score:** "S-Tier (12% underpriced)".
    *   **The Mechanic (AI):** User clicks "Run AI Scan".
        *   *Result:* "WARNING: Description mentions 'rod bearing noise'. Pass."
    *   **TCO Calculator:** "This M3 will cost you $450/month in gas+maintenance based on your 50km commute."
    *   **Negotiation:** User clicks "Generate Script".
        *   *Result:* "Tell seller: 'Market avg is $60k. This has wear. I offer $58k cash.'"

### 2.4 Retention (The Loop)
*   **Sniper Alerts:** User sets "Notify me: M3 < $55k".
    *   Hunter scrapes hourly.
    *   Email sent immediately on match.
*   **Saved Cars:** User tracks 5 cars.
    *   If a car sells, it shows as "SOLD/DELETED" in their list (doesn't vanish).

---

## 3. Comprehensive Feature List (The Matrix)

### ğŸ–¥ï¸ Frontend (The Architect & Integrator)
| Feature ID | Name | Description | Status |
| :--- | :--- | :--- | :--- |
| **FE-01** | **Landing Dashboard** | Hero section with "Trending Deals" carousel. | ğŸ”´ Pending |
| **FE-02** | **Swift Search Bar** | Instant-search with debouncing (local state). | ğŸ”´ Pending |
| **FE-03** | **Deal Cards** | Component showing Car Image, Price, and "Deal Grade" badge. | ğŸ”´ Pending |
| **FE-04** | **progressive-auth** | Logic to store guest state -> transfer to user after login. | ğŸ”´ Pending |
| **FE-05** | **Profile Modal** | Forced modal for first-time users to set Name/Commute. | ğŸ”´ Pending |
| **FE-06** | **Car Detail View** | Rich page with Gallery, Specs, Quant Score, and AI Actions. | ğŸ”´ Pending |
| **FE-07** | **Visual TCO Graph** | Chart showing cumulative cost over 1-5 years. | ğŸ”´ Pending |
| **FE-08** | **Sniper UI** | Form to set alert parameters (Price range, Model, Year). | ğŸ”´ Pending |
| **FE-09** | **Saved Garage** | List view of saved cars with "Sold" and "Price Drop" badges. | ğŸ”´ Pending |
| **FE-10** | **Negotiation Overlay** | Copy-pasteable script generated by AI. | ğŸ”´ Pending |

### âš™ï¸ Backend API (The Controller)
| Feature ID | Name | Description | Status |
| :--- | :--- | :--- | :--- |
| **BE-01** | **Car Ingestion** | `POST /cars` endpoint for Scraper. | âœ… Done |
| **BE-02** | **Car Retrieval** | `GET /cars` with pagination and filtering. | âœ… Done |
| **BE-03** | **Trending Alg** | `GET /trending` returning top S-Tier cars in GTA. | ğŸ”´ Pending |
| **BE-04** | **AI Analysis** | `POST /analyze` triggering Gemini Flash on description. | âœ… Done |
| **BE-05** | **User Profile** | `PATCH /me` to save Name, Commute, Preferences. | ğŸ”´ Pending |
| **BE-06** | **Search Logic** | Complex query builder (Make + Model + Price + Radius). | ğŸ”´ Pending |
| **BE-07** | **Sniper Logic** | `POST /alerts` to save search criteria. | ğŸ”´ Pending |
| **BE-08** | **TCO Service** | `services/tco.py` math function (Gas * Miles). | ğŸ”´ Pending |
| **BE-09** | **Negotiation API** | Endpoint to request AI script generation. | ğŸ”´ Pending |
| **BE-10** | **CORS & Security** | Middleware to allow Frontend headers. | ğŸ”´ Pending |

### ğŸ•·ï¸ Scraper (The Hunter)
| Feature ID | Name | Description | Status |
| :--- | :--- | :--- | :--- |
| **SC-01** | **AutoTrader.ca Bot** | Golang Colly script to parse GTA listings. | ğŸ”´ Pending |
| **SC-02** | **Delta Logic** | Detect when a car is removed (Sold/Deleted). | ğŸ”´ Pending |
| **SC-03** | **Scheduler** | Cron job to run Velocity-based scraping (Hourly/Daily). | ğŸ”´ Pending |
| **SC-04** | **Currency Normalizer**| Ensure all prices are converted/stored as CAD. | ğŸ”´ Pending |

### ğŸ§  Analytics (The Quant)
| Feature ID | Name | Description | Status |
| :--- | :--- | :--- | :--- |
| **QA-01** | **FMV Algorithm** | Python script to calculate "Fair Market Value" regression. | ğŸ”´ Pending |
| **QA-02** | **Deal Grading** | Assign S/A/B/C/F grade based on Price vs FMV. | ğŸ”´ Pending |
| **QA-03** | **Outlier Detection** | Flag prices that are "Too Good To Be True" (Scam/Parts).| ğŸ”´ Pending |

---

## 4. Cross-Feature Logic (Edge Cases)

### 4.1 The "Ghost Car" Handler
*   **Scenario:** User clicks a saved car that was sold 1 hour ago.
*   **Logic:**
    1.  Frontend requests car.
    2.  Backend checks `status`.
    3.  If `active`, Backend *optionally* triggers a "Live Check" (fast scrape).
    4.  If 404/Sold, Backend updates DB to `status=sold`.
    5.  Frontend shows "Sold" banner.

### 4.2 The "Profile Sync"
*   **Scenario:** Guest user has filtered for "SUVs" and "Under $20k". Then they login.
*   **Logic:**
    1.  Frontend sends `guest_filters` in the login callback.
    2.  Backend updates the User's permanent profile with these preferences if the profile was empty.

---

**Last Updated:** 2026-01-18
**Version:** 1.0 (Toronto Edition)
